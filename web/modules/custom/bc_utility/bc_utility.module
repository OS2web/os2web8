<?php

use Drupal\bc_utility\Controller\OldContentNotity;
use Drupal\Component\Render\FormattableMarkup;

/**
 * @file
 * Implementing custom hook functions
 */
function bc_utility_cron()
{
  $now = date("Y-m-01");
  $run = false;
  $last_start = \Drupal::keyValue('bc_utility_cron')->get('last_start');
  if (empty($last_start))
  {
    $run = true;
    \Drupal::keyValue('bc_utility_cron')->set('last_start', $now);
  }
  else
  {
    $lastdiff = strtotime("+1 month", strtotime($last_start));
    $run = ($now === date('Y-m-01', $lastdiff));
    // TODO or older that now + one month
  }

  if ($run) {
    Drupal::logger('bc_utility')->info("bc utility cron run");
    OldContentNotity::handler();
  }
}

function bc_utility_mail($key, &$message, $params)
{
  if ($key === 'old_article')
  {
    if (isset($params['headers']))
    {
      $message['headers'] = array_merge($message['headers'], $params['headers']);
    }

    $message['from'] = $params['from'];
    $message['subject'] = t($params['subject']);
    $message['body'][] = new FormattableMarkup($params['body'], []);
  }
}
